# Luming Compiler

Luming v1 递归展开规则

1. 术语定义

1.1 模板（Template）

由名称首次声明产生的结构定义单元。
模板包含：

默认样式集合

默认子模板列表（若存在父子声明）

模板本身不直接渲染。

1.2 显式子节点（Explicit Child）

在源码中通过嵌套语法直接写出的子结构。

例如：

A[A[A]]


其中两个内部 A 均为显式子节点。

1.3 模板子节点（Template Child）

通过模板默认子列表在展开阶段生成的子节点。

例如：

A[B]
B[C]


当展开 A 时，B 是模板子节点；
当展开 B 时，C 是模板子节点。

2. 展开模型

Luming 采用“两阶段模型”：

第一阶段：构建阶段

构建模板表

记录覆盖式父 → 子关系

记录样式修饰

不生成实例

第二阶段：展开阶段

从所有“无父模板”开始递归展开，生成实例树。

3. 循环展开控制规则
3.1 路径栈

展开过程中维护一个当前路径栈：

path = [T1, T2, ..., Tn]


表示当前展开链上的模板序列。

3.2 循环检测规则

在展开某个子节点 C 时：

若 C 来源为 显式子节点
→ 永远允许展开，不参与循环检测。

若 C 来源为 模板子节点
→ 若 C 的模板名称已存在于当前路径栈
→ 生成该节点实例，但不继续展开其子节点。
→ 否则
→ 正常展开。

4. 语义效果说明
4.1 显式递归嵌套合法
A[A[A]]


为显式结构，不触发循环截断。

展开结果为三层嵌套。

4.2 模板循环引用安全截断
A[B]
B[A]


展开 A 时结果为：

A
 └ B
     └ A (终止节点)


不会无限递归。

4.3 显式优先原则

显式结构永远优先于模板关系。

即：

模板循环只影响通过模板关系生成的节点。

用户显式写下的结构永远被完整保留。

5. 终止节点

当因循环检测而停止展开某节点时：

该节点仍正常渲染

其样式仍生效

仅不再展开其子模板列表

终止节点不具有特殊视觉标记。